<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= program.name %> - Daily Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .tracker-table {
      font-size: 0.9rem;
    }
    .tracker-table th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
    }
    .student-name {
      font-weight: 600;
      white-space: nowrap;
      position: sticky;
      left: 0;
      background: white;
      z-index: 5;
    }
    .metric-input {
      min-width: 80px;
    }
    .metric-input input[type="number"],
    .metric-input input[type="text"] {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .attendance-check {
      transform: scale(1.5);
      cursor: pointer;
    }
    .quick-actions {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 1rem 0;
      border-bottom: 2px solid #dee2e6;
    }
  </style>
</head>
<body>
  <div class="container-fluid mt-3">
    <div class="quick-actions">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1><i class="bi bi-clipboard-check"></i> Daily Tracker</h1>
          <p class="text-muted mb-0"><%= program.name %></p>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <label for="dateSelect" class="form-label mb-0 me-2">Date:</label>
          <input
            type="date"
            class="form-control"
            id="dateSelect"
            value="<%= date %>"
            onchange="window.location.href='/classroom/<%= program._id %>/tracker?date=' + this.value"
          >
          <a href="/classroom/<%= program._id %>/manage" class="btn btn-outline-secondary">
            <i class="bi bi-gear"></i> Manage
          </a>
        </div>
      </div>
    </div>

    <% if (success) { %>
      <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <% if (attendees && attendees.length > 0) { %>
      <form action="/classroom/<%= program._id %>/tracker/submit" method="POST" id="trackerForm">
        <input type="hidden" name="date" value="<%= date %>">

        <div class="card mt-3">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered tracker-table mb-0">
                <thead>
                  <tr>
                    <th class="student-name">Student</th>
                    <th class="text-center">
                      <i class="bi bi-calendar-check"></i> Present
                      <br>
                      <small>
                        <a href="#" onclick="checkAll(true); return false;">All</a> |
                        <a href="#" onclick="checkAll(false); return false;">None</a>
                      </small>
                    </th>
                    <% metrics.forEach(metric => { %>
                      <th>
                        <%= metric.name %>
                        <br><small class="text-muted"><%= metric.type %></small>
                      </th>
                    <% }) %>
                  </tr>
                </thead>
                <tbody>
                  <% attendees.forEach(student => { %>
                    <% const memberId = student.member?._id || student._id; %>
                    <tr>
                      <td class="student-name">
                        <%= student.firstName %> <%= student.lastName %>
                        <% if (student.grade) { %>
                          <br><small class="text-muted">Grade <%= student.grade %></small>
                        <% } %>
                      </td>

                      <!-- Attendance Checkbox -->
                      <td class="text-center">
                        <input
                          type="checkbox"
                          class="form-check-input attendance-check"
                          name="attendance[<%= memberId %>]"
                          value="true"
                          <%= attendanceMap[memberId] ? 'checked' : '' %>
                        >
                      </td>

                      <!-- Metric Inputs -->
                      <% metrics.forEach(metric => { %>
                        <% const metricKey = `${memberId}_${metric._id}`; %>
                        <% const existingValue = metricValueMap[metricKey]; %>
                        <td class="metric-input">
                          <% if (metric.type === 'number') { %>
                            <input
                              type="number"
                              class="form-control form-control-sm"
                              name="metrics[<%= metricKey %>]"
                              placeholder="1-5"
                              min="1"
                              max="5"
                              step="1"
                              value="<%= existingValue || '' %>"
                            >
                          <% } else if (metric.type === 'boolean') { %>
                            <select
                              class="form-select form-select-sm"
                              name="metrics[<%= metricKey %>]"
                            >
                              <option value="">-</option>
                              <option value="true" <%= existingValue === true ? 'selected' : '' %>>Yes</option>
                              <option value="false" <%= existingValue === false ? 'selected' : '' %>>No</option>
                            </select>
                          <% } else if (metric.type === 'text') { %>
                            <input
                              type="text"
                              class="form-control form-control-sm"
                              name="metrics[<%= metricKey %>]"
                              placeholder="<%= metric.name %>"
                              value="<%= existingValue || '' %>"
                            >
                          <% } else if (metric.type === 'date') { %>
                            <input
                              type="date"
                              class="form-control form-control-sm"
                              name="metrics[<%= metricKey %>]"
                              value="<%= existingValue || '' %>"
                            >
                          <% } %>
                        </td>
                      <% }) %>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-3 mb-5">
          <div>
            <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
              <i class="bi bi-arrow-left"></i> Cancel
            </button>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" onclick="clearForm()">
              <i class="bi bi-eraser"></i> Clear All
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save"></i> Save Attendance & Metrics
            </button>
          </div>
        </div>
      </form>

      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> <strong>Quick Tips:</strong>
        <ul class="mb-0 mt-2">
          <li>Use "All" / "None" links to quickly check/uncheck all attendance</li>
          <li>Behavior and Participation use 1-5 scale (1=Poor, 5=Excellent)</li>
          <li>Leave fields blank if not applicable for that day</li>
          <li>Data auto-saves when you click "Save Attendance & Metrics"</li>
        </ul>
      </div>

    <% } else { %>
      <div class="alert alert-warning mt-3">
        <i class="bi bi-exclamation-triangle"></i>
        No students enrolled in this program yet.
        <a href="/classroom/<%= program._id %>/manage" class="btn btn-sm btn-primary ms-2">
          Add Students
        </a>
      </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check/uncheck all attendance checkboxes
    function checkAll(checked) {
      document.querySelectorAll('.attendance-check').forEach(cb => {
        cb.checked = checked;
      });
    }

    // Clear all form inputs
    function clearForm() {
      if (confirm('Clear all entries for this date?')) {
        // Uncheck all attendance
        checkAll(false);

        // Clear all metric inputs
        document.querySelectorAll('.metric-input input, .metric-input select').forEach(input => {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
        });
      }
    }

    // Auto-save warning before leaving page with unsaved changes
    let formChanged = false;
    document.getElementById('trackerForm')?.addEventListener('change', () => {
      formChanged = true;
    });

    document.getElementById('trackerForm')?.addEventListener('submit', () => {
      formChanged = false;
    });

    window.addEventListener('beforeunload', (e) => {
      if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
