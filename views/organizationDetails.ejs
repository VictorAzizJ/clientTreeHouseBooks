<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organization Details - TreeHouseBooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/treehouse-brand.css">
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container mt-5">

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Deleted Organization Warning -->
    <% if (organization.isDeleted) { %>
      <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <span><strong>This organization has been deleted.</strong> It is hidden from normal views.</span>
        <% if (user.role === 'admin') { %>
          <form action="/organizations/<%= organization._id %>/restore" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success btn-sm">Restore Organization</button>
          </form>
        <% } %>
      </div>
    <% } %>

    <!-- Header + Nav -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="bi bi-building"></i> <%= organization.name %></h1>
      <div>
        <% if (user.role === 'admin' && !organization.isDeleted) { %>
          <a href="/organizations/<%= organization._id %>/edit" class="btn btn-warning me-2">
            <i class="bi bi-pencil"></i> Edit
          </a>
          <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash"></i> Delete
          </button>
        <% } %>
        <a href="/organizations" class="btn btn-primary me-2">
          <i class="bi bi-arrow-left"></i> Organizations
        </a>
        <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
      </div>
    </div>

    <!-- Organization Info -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-info-circle"></i> Organization Information
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Type:</strong>
              <span class="badge bg-secondary"><%= (organization.organizationType || 'other').replace('_', ' ') %></span>
            </p>
            <p><strong>Address:</strong> <%= organization.address || 'N/A' %></p>
            <p><strong>Zip Code:</strong> <%= organization.zipCode || 'N/A' %></p>
            <p><strong>Created:</strong> <%= new Date(organization.createdAt).toLocaleDateString() %></p>
          </div>
          <div class="col-md-6">
            <h6><i class="bi bi-person-lines-fill"></i> Contact Information</h6>
            <p><strong>Contact Person:</strong> <%= organization.contactName || 'N/A' %></p>
            <p><strong>Phone:</strong>
              <% if (organization.phone) { %>
                <a href="tel:<%= organization.phone %>"><%= organization.phone %></a>
              <% } else { %>
                N/A
              <% } %>
            </p>
            <p><strong>Email:</strong>
              <% if (organization.email) { %>
                <a href="mailto:<%= organization.email %>"><%= organization.email %></a>
              <% } else { %>
                N/A
              <% } %>
            </p>
            <p><strong>Contact Notes:</strong> <%= organization.contactMethod || 'N/A' %></p>
            <p><strong>How They Heard About Us:</strong> <%= organization.howHeardAboutUs || 'N/A' %></p>
          </div>
        </div>
        <% if (organization.notes) { %>
          <hr>
          <p><strong>Notes:</strong></p>
          <p class="text-muted"><%= organization.notes %></p>
        <% } %>
      </div>
    </div>

    <!-- Related Traveling Stops -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-truck"></i> Traveling Tree House Stops</span>
        <a href="/traveling-treehouse/new?organization=<%= organization._id %>" class="btn btn-sm btn-outline-success">
          <i class="bi bi-plus"></i> New Stop
        </a>
      </div>
      <div class="card-body">
        <% if (travelingStops.length === 0) { %>
          <p class="text-muted">No traveling stops recorded for this organization.</p>
        <% } else { %>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Adults</th>
                <th>Kids</th>
                <th>Books Distributed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% travelingStops.forEach(stop => { %>
                <tr>
                  <td><%= new Date(stop.visitDate).toLocaleDateString() %></td>
                  <td><%= stop.adultsReached || 0 %></td>
                  <td><%= stop.kidsReached || 0 %></td>
                  <td><%= stop.booksDistributed || 0 %></td>
                  <td>
                    <a href="/traveling-treehouse/<%= stop._id %>" class="btn btn-sm btn-outline-primary">View</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
          <% if (travelingStops.length >= 10) { %>
            <p class="text-muted small">Showing last 10 stops. <a href="/traveling-treehouse?organization=<%= organization._id %>">View all</a></p>
          <% } %>
        <% } %>
      </div>
    </div>

    <!-- Related Donations -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gift"></i> Donations from this Organization</span>
        <a href="/donations/new?organization=<%= organization._id %>" class="btn btn-sm btn-outline-info">
          <i class="bi bi-plus"></i> New Donation
        </a>
      </div>
      <div class="card-body">
        <% if (donations.length === 0) { %>
          <p class="text-muted">No donations recorded from this organization.</p>
        <% } else { %>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Books</th>
                <th>Monetary</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% donations.forEach(donation => { %>
                <tr>
                  <td><%= new Date(donation.donatedAt).toLocaleDateString() %></td>
                  <td><span class="badge <%= donation.donationType === 'new' ? 'bg-success' : 'bg-secondary' %>"><%= donation.donationType %></span></td>
                  <td><%= donation.numberOfBooks %></td>
                  <td><%= donation.monetaryAmount ? '$' + donation.monetaryAmount.toFixed(2) : '-' %></td>
                  <td>
                    <a href="/donations/<%= donation._id %>" class="btn btn-sm btn-outline-primary">View</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
          <% if (donations.length >= 10) { %>
            <p class="text-muted small">Showing last 10 donations. <a href="/donations?organization=<%= organization._id %>">View all</a></p>
          <% } %>
        <% } %>
      </div>
    </div>

    <!-- Change History (Admin Only) -->
    <% if (user.role === 'admin') { %>
      <div class="card mb-5">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <span><i class="bi bi-clock-history"></i> Change History</span>
          <button class="btn btn-sm btn-light" onclick="loadHistory()">Refresh</button>
        </div>
        <div class="card-body">
          <div id="historyContainer">
            <p class="text-muted">Click "Refresh" to load change history...</p>
          </div>
        </div>
      </div>
    <% } %>

  </div>

  <!-- Delete Confirmation Modal -->
  <% if (user.role === 'admin') { %>
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete <strong><%= organization.name %></strong>?</p>
            <p class="text-muted small">This is a soft delete - the record can be restored later by an admin.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form action="/organizations/<%= organization._id %>/delete" method="POST" class="d-inline">
              <button type="submit" class="btn btn-danger">Delete Organization</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <% if (user.role === 'admin') { %>
  <script>
    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      container.innerHTML = '<p class="text-muted">Loading...</p>';

      try {
        const response = await fetch('/organizations/<%= organization._id %>/history');
        const history = await response.json();

        if (history.length === 0) {
          container.innerHTML = '<p class="text-muted">No changes recorded yet.</p>';
          return;
        }

        let html = '<table class="table table-sm"><thead><tr><th>Date</th><th>Action</th><th>Changed By</th><th>Details</th></tr></thead><tbody>';

        history.forEach(entry => {
          const date = new Date(entry.timestamp).toLocaleString();
          const user = entry.performedBy ? `${entry.performedBy.firstName || ''} ${entry.performedBy.lastName || ''}`.trim() || entry.performedBy.email : 'Unknown';
          const action = entry.action.charAt(0).toUpperCase() + entry.action.slice(1);

          let details = '';
          if (entry.action === 'update' && entry.changedFields && entry.changedFields.length > 0) {
            details = 'Changed: ' + entry.changedFields.join(', ');
          } else if (entry.summary) {
            details = entry.summary;
          }

          let badgeClass = 'bg-secondary';
          if (entry.action === 'create') badgeClass = 'bg-success';
          if (entry.action === 'update') badgeClass = 'bg-primary';
          if (entry.action === 'delete') badgeClass = 'bg-danger';
          if (entry.action === 'restore') badgeClass = 'bg-warning text-dark';

          html += `<tr>
            <td><small>${date}</small></td>
            <td><span class="badge ${badgeClass}">${action}</span></td>
            <td><small>${user}</small></td>
            <td><small>${details}</small></td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<p class="text-danger">Failed to load history.</p>';
        console.error('Error loading history:', err);
      }
    }

    // Auto-load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
  <% } %>
</body>
</html>
