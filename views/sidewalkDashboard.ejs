<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sidewalk Inventory - TreeHouseBooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/treehouse-brand.css">
  <style>
    .category-card {
      transition: all 0.2s ease;
      border: none;
      border-radius: 1rem;
      overflow: hidden;
    }
    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .category-header {
      padding: 1.5rem;
      color: white;
    }
    .category-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .stat-badge {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .trend-up { color: #059669; }
    .trend-down { color: #dc3545; }
    .trend-stable { color: #6b7280; }
    .formula-info {
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }
    .formula-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .formula-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1><i class="bi bi-shop-window"></i> Sidewalk Inventory</h1>
        <p class="text-muted">Track weekly inventory across all sidewalk book locations</p>
      </div>
      <a href="/dashboard" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Category Cards -->
    <div class="row mb-4">
      <% categories.forEach(cat => { %>
        <div class="col-md-6 col-lg-3 mb-4">
          <div class="card category-card h-100">
            <div class="category-header" style="background-color: <%= cat.color %>;">
              <i class="bi <%= cat.icon %> category-icon"></i>
              <h4 class="mb-1"><%= cat.name %></h4>
              <small class="opacity-75"><%= cat.description %></small>
            </div>
            <div class="card-body">
              <% if (cat.latest) { %>
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Latest Week:</span>
                    <span class="stat-badge bg-light">
                      <%= new Date(cat.latest.weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                    </span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Current Count:</span>
                    <span class="stat-badge bg-secondary text-white"><%= cat.latest.endCount %></span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Weekly Change:</span>
                    <span class="stat-badge <%= cat.latest.change > 0 ? 'bg-success' : cat.latest.change < 0 ? 'bg-warning' : 'bg-secondary' %> text-white">
                      <%= cat.latest.change > 0 ? '+' : '' %><%= cat.latest.change %>
                    </span>
                  </div>
                </div>
              <% } else { %>
                <div class="text-center text-muted py-3">
                  <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                  <p class="mb-0 mt-2">No records yet</p>
                </div>
              <% } %>
              <div class="d-grid gap-2 mt-3">
                <a href="/sidewalk/<%= cat.id %>" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-list-ul"></i> View Records
                </a>
                <a href="/sidewalk/<%= cat.id %>/new" class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-lg"></i> Add Week
                </a>
              </div>
            </div>
            <div class="card-footer bg-light text-muted small">
              <i class="bi bi-archive"></i> <%= cat.summary.totalRecords %> total records
            </div>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- Shared Formula Information -->
    <div class="card">
      <div class="card-header" style="background-color: var(--thb-primary); color: white;">
        <h5 class="mb-0"><i class="bi bi-calculator"></i> Shared Formula Configuration</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">All four sidewalk categories use the same formulas for consistent tracking:</p>
        <div class="row">
          <div class="col-md-6">
            <div class="formula-info">
              <h6><i class="bi bi-gear"></i> Active Formulas</h6>
              <div class="formula-item">
                <span>Change</span>
                <code>endCount - startCount</code>
              </div>
              <div class="formula-item">
                <span>% Change</span>
                <code>((end - start) / start) Ã— 100</code>
              </div>
              <div class="formula-item">
                <span>Distribution Rate</span>
                <code>|change| / 7 days</code>
              </div>
              <div class="formula-item">
                <span>Restock Needed</span>
                <code>targetCount - endCount</code>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="formula-info">
              <h6><i class="bi bi-info-circle"></i> How It Works</h6>
              <ul class="mb-0">
                <li>All categories track start and end of week counts</li>
                <li>Formulas calculate change, trends, and restock needs</li>
                <li>Values remain editable - formulas auto-recalculate</li>
                <li>Updates propagate consistently across all categories</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-outline-secondary btn-sm" onclick="checkSync()">
            <i class="bi bi-arrow-repeat"></i> Check Formula Sync
          </button>
          <span id="syncStatus" class="ms-2"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function checkSync() {
      const statusEl = document.getElementById('syncStatus');
      statusEl.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split"></i> Checking...</span>';

      try {
        const response = await fetch('/sidewalk/api/sync');
        const result = await response.json();

        if (result.success) {
          statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> All formulas synchronized correctly</span>';
        } else {
          statusEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> ${result.message}</span>`;
          console.log('Inconsistencies:', result.inconsistencies);
        }
      } catch (err) {
        statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Sync check failed</span>';
      }
    }
  </script>
</body>
</html>
