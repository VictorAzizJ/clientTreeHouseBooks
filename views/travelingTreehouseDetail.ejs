<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= stop.stopName %> - Traveling Tree House</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/treehouse-brand.css">
  <style>
    .type-badge {
      font-size: 0.85rem;
      padding: 0.35rem 0.75rem;
      border-radius: 1rem;
    }
    .type-daycare { background-color: #17a2b8; color: white; }
    .type-branch { background-color: #28a745; color: white; }
    .type-community_event { background-color: #ffc107; color: #212529; }
    .detail-card {
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .detail-card .card-header {
      border-bottom: 2px solid var(--thb-secondary);
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #6c757d;
      font-weight: 500;
    }
    .info-value {
      font-weight: 500;
      text-align: right;
    }
    .boolean-yes { color: #28a745; }
    .boolean-no { color: #6c757d; }
    .highlight-stat {
      background: linear-gradient(135deg, var(--thb-primary) 0%, var(--thb-secondary) 100%);
      color: white;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
    }
    .highlight-stat h2 {
      font-size: 2.5rem;
      margin: 0;
    }
  </style>
</head>
<body>
  <%- include('partials/nav') %>

  <div class="container mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/traveling-treehouse">Traveling Tree House</a></li>
            <li class="breadcrumb-item active"><%= stop.stopName %></li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Success Alert -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Header with Actions -->
    <div class="row mb-4">
      <div class="col-md-8">
        <div class="d-flex align-items-center gap-3 mb-2">
          <h1 class="mb-0"><%= stop.stopName %></h1>
          <span class="type-badge type-<%= stop.stopType %>">
            <%= formatStopType(stop.stopType) %>
          </span>
        </div>
        <p class="text-muted mb-0">
          <i class="bi bi-calendar3"></i>
          <%= new Date(stop.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
        </p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="/traveling-treehouse/<%= stop._id %>/edit" class="btn btn-outline-primary">
          <i class="bi bi-pencil"></i> Edit
        </a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
          <i class="bi bi-trash"></i> Delete
        </button>
      </div>
    </div>

    <div class="row">
      <!-- Main Info Column -->
      <div class="col-lg-8">
        <!-- Books Distributed Highlight -->
        <div class="highlight-stat mb-4">
          <i class="bi bi-book" style="font-size: 2rem;"></i>
          <h2><%= stop.booksDistributed.toLocaleString() %></h2>
          <p class="mb-0">Books Distributed</p>
        </div>

        <!-- Location Card -->
        <div class="card detail-card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Location</h5>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">Address</span>
              <span class="info-value"><%= stop.stopAddress %></span>
            </div>
            <div class="info-row">
              <span class="info-label">ZIP Code</span>
              <span class="info-value"><%= stop.stopZipCode %></span>
            </div>
          </div>
        </div>

        <!-- Contact & Outreach Card -->
        <div class="card detail-card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-megaphone"></i> Contact & Outreach</h5>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">How were we contacted?</span>
              <span class="info-value"><%= stop.contactMethod || '—' %></span>
            </div>
            <div class="info-row">
              <span class="info-label">How did they hear about us?</span>
              <span class="info-value"><%= stop.howHeardAboutUs || '—' %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Did we read to them?</span>
              <span class="info-value">
                <% if (stop.didWeReadToThem) { %>
                  <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                <% } else { %>
                  <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                <% } %>
              </span>
            </div>
          </div>
        </div>

        <!-- Type-Specific Details -->
        <% if (stop.stopType === 'daycare') { %>
          <div class="card detail-card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-house-heart"></i> Daycare Details
                <span class="type-badge type-daycare ms-2">Daycare</span>
              </h5>
            </div>
            <div class="card-body">
              <div class="info-row">
                <span class="info-label">Do they have our sticker displayed?</span>
                <span class="info-value">
                  <% if (stop.daycareSettings?.hasStickerDisplayed) { %>
                    <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                  <% } else { %>
                    <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                  <% } %>
                </span>
              </div>
            </div>
          </div>
        <% } %>

        <% if (stop.stopType === 'branch') { %>
          <div class="card detail-card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-building"></i> Branch Details
                <span class="type-badge type-branch ms-2">Branch</span>
              </h5>
            </div>
            <div class="card-body">
              <div class="info-row">
                <span class="info-label">Do they have THB signage displayed?</span>
                <span class="info-value">
                  <% if (stop.branchSettings?.hasSignageDisplayed) { %>
                    <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                  <% } else { %>
                    <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                  <% } %>
                </span>
              </div>
            </div>
          </div>
        <% } %>

        <% if (stop.stopType === 'community_event') { %>
          <div class="card detail-card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-calendar-event"></i> Community Event Details
                <span class="type-badge type-community_event ms-2">Event</span>
              </h5>
            </div>
            <div class="card-body">
              <div class="info-row">
                <span class="info-label">Were we on their promotional flyer?</span>
                <span class="info-value">
                  <% if (stop.communityEventSettings?.wereWeOnFlyer) { %>
                    <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                  <% } else { %>
                    <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                  <% } %>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">Did they feature us on their social media?</span>
                <span class="info-value">
                  <% if (stop.communityEventSettings?.featuredOnTheirSocialMedia) { %>
                    <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                  <% } else { %>
                    <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                  <% } %>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">Did we share on our social media?</span>
                <span class="info-value">
                  <% if (stop.communityEventSettings?.didWeShareOnOurSocialMedia) { %>
                    <span class="boolean-yes"><i class="bi bi-check-circle-fill"></i> Yes</span>
                  <% } else { %>
                    <span class="boolean-no"><i class="bi bi-x-circle"></i> No</span>
                  <% } %>
                </span>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Notes -->
        <% if (stop.notes) { %>
          <div class="card detail-card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-journal-text"></i> Notes</h5>
            </div>
            <div class="card-body">
              <p class="mb-0" style="white-space: pre-wrap;"><%= stop.notes %></p>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card detail-card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="/traveling-treehouse/<%= stop._id %>/edit" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit This Stop
              </a>
              <a href="/traveling-treehouse/new" class="btn btn-outline-success">
                <i class="bi bi-plus-lg"></i> Record New Stop
              </a>
              <a href="/traveling-treehouse" class="btn btn-outline-secondary">
                <i class="bi bi-list-ul"></i> View All Stops
              </a>
              <a href="/traveling-treehouse/dashboard" class="btn btn-outline-info">
                <i class="bi bi-graph-up"></i> View Analytics
              </a>
            </div>
          </div>
        </div>

        <!-- Metadata -->
        <div class="card detail-card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Record Info</h5>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">Created By</span>
              <span class="info-value">
                <% if (stop.createdBy) { %>
                  <%= stop.createdBy.firstName %> <%= stop.createdBy.lastName %>
                <% } else { %>
                  —
                <% } %>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value">
                <%= new Date(stop.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Updated</span>
              <span class="info-value">
                <%= new Date(stop.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="mt-4 mb-5">
      <a href="/traveling-treehouse" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to All Stops
      </a>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle text-danger"></i> Confirm Delete
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this stop record?</p>
          <p class="mb-0">
            <strong><%= stop.stopName %></strong><br>
            <small class="text-muted"><%= stop.date %> &bull; <%= stop.booksDistributed %> books distributed</small>
          </p>
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle"></i> This action cannot be undone.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form action="/traveling-treehouse/<%= stop._id %>/delete" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-trash"></i> Delete Stop
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
