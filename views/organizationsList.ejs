<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizations - TreeHouseBooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/treehouse-brand.css">
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container mt-5">

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="bi bi-building"></i> Organizations</h1>
      <div>
        <% if (user.role === 'admin' || user.role === 'staff') { %>
          <a href="/organizations/new" class="btn btn-success me-2">
            <i class="bi bi-plus-circle"></i> Add Organization
          </a>
        <% } %>
        <a href="/dashboard" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Dashboard
        </a>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" action="/organizations" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" name="search" class="form-control" placeholder="Name, address, notes..." value="<%= search %>">
          </div>
          <div class="col-md-3">
            <label class="form-label">Organization Type</label>
            <select name="type" class="form-select">
              <option value="">All Types</option>
              <% organizationTypes.forEach(type => { %>
                <option value="<%= type %>" <%= typeFilter === type ? 'selected' : '' %>><%= type.replace('_', ' ') %></option>
              <% }) %>
            </select>
          </div>
          <% if (user.role === 'admin') { %>
            <div class="col-md-2">
              <label class="form-label">Show Deleted</label>
              <div class="form-check">
                <input type="checkbox" name="showDeleted" value="true" class="form-check-input" <%= showDeleted ? 'checked' : '' %>>
                <label class="form-check-label">Include deleted</label>
              </div>
            </div>
          <% } %>
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2">
              <i class="bi bi-search"></i> Search
            </button>
            <a href="/organizations" class="btn btn-outline-secondary">Clear</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Stats -->
    <p class="text-muted mb-3">
      Showing <%= organizations.length %> of <%= pagination.totalOrganizations %> organizations
      <% if (search) { %> matching "<strong><%= search %></strong>"<% } %>
      <% if (typeFilter) { %> of type "<strong><%= typeFilter.replace('_', ' ') %></strong>"<% } %>
    </p>

    <!-- Organizations Table -->
    <% if (organizations.length === 0) { %>
      <div class="alert alert-info">
        No organizations found. <a href="/organizations/new">Add one?</a>
      </div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Address</th>
              <th>Zip Code</th>
              <th>Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% organizations.forEach(org => { %>
              <tr class="<%= org.isDeleted ? 'table-secondary' : '' %>">
                <td>
                  <a href="/organizations/<%= org._id %>">
                    <strong><%= org.name %></strong>
                  </a>
                  <% if (org.isDeleted) { %>
                    <span class="badge bg-danger ms-1">Deleted</span>
                  <% } %>
                </td>
                <td>
                  <span class="badge bg-secondary"><%= (org.organizationType || 'other').replace('_', ' ') %></span>
                </td>
                <td><%= org.address ? (org.address.length > 30 ? org.address.substring(0, 30) + '...' : org.address) : '-' %></td>
                <td><%= org.zipCode || '-' %></td>
                <td><%= org.contactMethod ? (org.contactMethod.length > 25 ? org.contactMethod.substring(0, 25) + '...' : org.contactMethod) : '-' %></td>
                <td>
                  <a href="/organizations/<%= org._id %>" class="btn btn-sm btn-outline-primary">View</a>
                  <% if (user.role === 'admin' && !org.isDeleted) { %>
                    <a href="/organizations/<%= org._id %>/edit" class="btn btn-sm btn-outline-warning">Edit</a>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination.totalPages > 1) { %>
        <nav aria-label="Organizations pagination">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
              <a class="page-link" href="/organizations?page=<%= pagination.currentPage - 1 %>&search=<%= search %>&type=<%= typeFilter %>&showDeleted=<%= showDeleted %>">Previous</a>
            </li>
            <% for (let i = 1; i <= pagination.totalPages; i++) { %>
              <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                <a class="page-link" href="/organizations?page=<%= i %>&search=<%= search %>&type=<%= typeFilter %>&showDeleted=<%= showDeleted %>"><%= i %></a>
              </li>
            <% } %>
            <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
              <a class="page-link" href="/organizations?page=<%= pagination.currentPage + 1 %>&search=<%= search %>&type=<%= typeFilter %>&showDeleted=<%= showDeleted %>">Next</a>
            </li>
          </ul>
        </nav>
      <% } %>
    <% } %>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
