<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard</title>
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet" />
  <style>
    #search-results { max-height: 50vh; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1>Staff Dashboard</h1>

    <!-- ─── QUICK LINKS ROW ────────────────────────── -->
    <div class="btn-toolbar mt-4 mb-3" role="toolbar">
      <div class="btn-group me-2" role="group">
        <a href="/members/new" class="btn btn-success">+ New Member</a>
        <a href="/members"     class="btn btn-primary">All Members</a>
      </div>
      <div class="btn-group" role="group">
        <button 
          id="member-details-btn" 
          class="btn btn-info" 
          disabled
        >
          View Member Details
        </button>
      </div>
    </div>

    <!-- ─── TOP WIDGETS ───────────────────────────── -->
    <div class="row g-3">
      <!-- Notifications -->
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-header bg-warning text-dark">
            Notifications
          </div>
          <div class="card-body">
            <h2 class="card-title">
              <%= notificationsCount %>
            </h2>
            <p class="card-text">new items</p>
          </div>
        </div>
      </div>
      <!-- Messages -->
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-header bg-primary text-white">Messages</div>
          <ul class="list-group list-group-flush">
            <% recentMessages.forEach(msg => { %>
              <li class="list-group-item text-start">
                <strong><%= msg.sender.firstName %>:</strong>
                <%= msg.content.length > 30 
                      ? msg.content.slice(0,30) + '…'
                      : msg.content %>
              </li>
            <% }) %>
            <% if (recentMessages.length === 0) { %>
              <li class="list-group-item">No recent messages</li>
            <% } %>
          </ul>
          <div class="card-footer">
            <a href="/messages" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
        </div>
      </div>
      <!-- Announcements -->
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-header bg-success text-white">Announcements</div>
          <ul class="list-group list-group-flush">
            <% recentAnns.forEach(a => { %>
              <li class="list-group-item text-start">
                <strong><%= a.sender.firstName %>:</strong>
                <%= a.content.length > 30 
                      ? a.content.slice(0,30) + '…'
                      : a.content %>
              </li>
            <% }) %>
            <% if (recentAnns.length === 0) { %>
              <li class="list-group-item">No recent announcements</li>
            <% } %>
          </ul>
          <div class="card-footer">
            <a href="/announcements" class="btn btn-sm btn-outline-success">
              View All
            </a>
          </div>
        </div>
      </div>
      <!-- Placeholder -->
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-header bg-secondary text-white">Placeholder</div>
          <div class="card-body">
            <p class="card-text">Coming soon…</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── MEMBER MANAGEMENT WIDGETS ─────────────── -->
    <div class="row g-4 mt-4">
      <!-- Lookup Member -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">Lookup Member</div>
          <div class="card-body">
            <div class="input-group mb-3">
              <input
                id="member-search"
                type="text"
                class="form-control"
                placeholder="Name or email…"
              />
              <button id="member-search-btn" class="btn btn-primary">
                Search
              </button>
            </div>
            <div id="search-results" class="list-group"></div>
          </div>
        </div>
      </div>
      <!-- Add New Member -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">Add New Member</div>
          <div class="card-body">
            <form id="add-member-form" action="/members" method="POST">
              <div class="mb-2">
                <input name="firstName" class="form-control" placeholder="First Name" required>
              </div>
              <div class="mb-2">
                <input name="lastName"    class="form-control" placeholder="Last Name" required>
              </div>
              <div class="mb-2">
                <input name="email"       type="email" class="form-control" placeholder="Email" required>
              </div>
              <div class="mb-2">
                <input name="phone"       class="form-control" placeholder="Phone">
              </div>
              <div class="mb-2">
                <textarea name="address" class="form-control" placeholder="Address"></textarea>
              </div>
              <button class="btn btn-success w-100">Add Member</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const searchInput = document.getElementById('member-search');
    const searchBtn   = document.getElementById('member-search-btn');
    const resultsDiv  = document.getElementById('search-results');
    const detailsBtn  = document.getElementById('member-details-btn');
    let selectedId = null;

    async function doSearch() {
      const q = searchInput.value.trim();
      if (q.length < 2) {
        resultsDiv.innerHTML = '';
        selectedId = null;
        detailsBtn.disabled = true;
        return;
      }
      const res = await fetch(`/members/search?q=${encodeURIComponent(q)}`);
      const items = await res.json();
      resultsDiv.innerHTML = items.length
        ? items.map(i => {
            if (!selectedId) selectedId = i.id;
            return `<a href="/members/${i.id}"
                       class="list-group-item list-group-item-action">
                      ${i.text}
                    </a>`;
          }).join('')
        : `<div class="list-group-item">No members found</div>`;
      detailsBtn.disabled = !selectedId;
    }

    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSearch();
      }
    });

    detailsBtn.addEventListener('click', () => {
      if (selectedId) {
        window.location.href = `/members/${selectedId}`;
      }
    });
  </script>
</body>
</html>
