<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Details - TreeHouseBooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/treehouse-brand.css">
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container mt-5">

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Deleted Member Warning -->
    <% if (member.isDeleted) { %>
      <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <span><strong>This member has been deleted.</strong> It is hidden from normal views.</span>
        <% if (user.role === 'admin') { %>
          <form action="/members/<%= member._id %>/restore" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success btn-sm">Restore Member</button>
          </form>
        <% } %>
      </div>
    <% } %>

    <!-- Header + Nav -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Member: <%= member.firstName %> <%= member.lastName %></h1>
      <div>
        <% if (user.role === 'admin' && !member.isDeleted) { %>
          <a href="/members/<%= member._id %>/edit" class="btn btn-warning me-2">Edit</a>
          <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
        <% } %>
        <a href="/members" class="btn btn-primary me-2">← Member List</a>
        <a href="/dashboard" class="btn btn-secondary">← Dashboard</a>
      </div>
    </div>

    <!-- Member Info -->
    <div class="card mb-4">
      <div class="card-header">Member Information</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Email:</strong> <%= member.email || 'N/A' %></p>
            <p><strong>Phone:</strong> <%= member.phone || 'N/A' %></p>
            <p><strong>Zip Code:</strong> <%= member.zipCode || 'N/A' %></p>
            <% if (user.role === 'staff' || user.role === 'admin') { %>
              <p><strong>Address:</strong> <%= member.address || 'N/A' %></p>
            <% } %>
          </div>
          <div class="col-md-6">
            <p><strong>Member Type:</strong> <%= member.memberType || 'adult' %></p>
            <% if (member.memberType === 'child' && member.parent) { %>
              <p><strong>Parent/Guardian:</strong> <a href="/members/<%= member.parent._id %>"><%= member.parent.firstName %> <%= member.parent.lastName %></a></p>
            <% } %>
            <% if (member.memberType === 'child') { %>
              <% if (member.dateOfBirth) { %><p><strong>Date of Birth:</strong> <%= new Date(member.dateOfBirth).toLocaleDateString() %></p><% } %>
              <% if (member.grade) { %><p><strong>Grade:</strong> <%= member.grade %></p><% } %>
              <% if (member.school) { %><p><strong>School:</strong> <%= member.school %></p><% } %>
            <% } %>
            <p><strong>Joined:</strong> <%= new Date(member.joinedAt).toLocaleDateString() %></p>
          </div>
        </div>
        <% if (member.notes) { %>
          <hr>
          <p><strong>Notes:</strong> <%= member.notes %></p>
        <% } %>
        <% if (member.emergencyContact && (member.emergencyContact.name || member.emergencyContact.phone)) { %>
          <hr>
          <p><strong>Emergency Contact:</strong>
            <%= member.emergencyContact.name || '' %>
            <%= member.emergencyContact.phone ? '(' + member.emergencyContact.phone + ')' : '' %>
            <%= member.emergencyContact.relationship ? '- ' + member.emergencyContact.relationship : '' %>
          </p>
        <% } %>
      </div>
    </div>

    <!-- Checkout History -->
    <h2>Checkout History</h2>
    <% if (checkoutHistory.length === 0) { %>
      <p>No previous checkouts.</p>
    <% } else { %>
      <table class="table mb-5">
        <thead>
          <tr>
            <th>#</th>
            <th>Books</th>
            <th>Genres</th>
            <th>Weight (kg)</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <% checkoutHistory.forEach((c, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><%= c.numberOfBooks %></td>
              <td><%= c.genres.join(', ') %></td>
              <td><%= c.weight ?? '—' %></td>
              <td><%= new Date(c.checkoutDate).toLocaleString() %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>

    <!-- New Checkout Form -->
    <div class="card mb-5">
      <div class="card-header bg-success text-white">Record a New Checkout</div>
      <div class="card-body">
        <form action="/checkouts" method="POST">
          <input type="hidden" name="memberId" value="<%= member._id %>"/>
          <input type="hidden" name="redirectTo" value="/members/<%= member._id %>"/>
          <div class="mb-3">
            <label class="form-label">Number of Books</label>
            <input type="number" name="numberOfBooks" class="form-control" min="1" required/>
          </div>
          <div class="mb-3">
            <label class="form-label">Genres</label><br/>
            <% ['Kids Board Books','Women Empowerment','Black Author','Young Adult'].forEach(g => { %>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="genres" value="<%= g %>" required/>
                <label class="form-check-label"><%= g %></label>
              </div>
            <% }) %>
          </div>
          <div class="mb-3">
            <label class="form-label">Total Weight (kg, optional)</label>
            <input type="number" name="weight" step="0.01" class="form-control"/>
          </div>
          <button type="submit" class="btn btn-success">Record Checkout</button>
        </form>
      </div>
    </div>

    <!-- Donation History -->
    <h2 class="mt-5">Donation History</h2>
    <% if (donationHistory.length === 0) { %>
      <p>No donations recorded.</p>
    <% } else { %>
      <table class="table mb-5">
        <thead>
          <tr>
            <th>#</th>
            <th>Books</th>
            <th>Genres</th>
            <th>Weight (kg)</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <% donationHistory.forEach((d, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><%= d.numberOfBooks %></td>
              <td><%= d.genres.join(', ') %></td>
              <td><%= d.weight ?? '—' %></td>
              <td><%= new Date(d.donatedAt).toLocaleString() %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>

    <!-- New Donation Form -->
    <div class="card mb-5">
      <div class="card-header bg-info text-white">Record a New Donation</div>
      <div class="card-body">
        <form action="/members/<%= member._id %>/donations" method="POST">
          <div class="mb-3">
            <label class="form-label">Number of Books</label>
            <input type="number" name="numberOfBooks" class="form-control" min="1" required/>
          </div>
          <div class="mb-3">
            <label class="form-label">Genres</label><br/>
            <% ['Kids Board Books','Women Empowerment','Black Author','Young Adult'].forEach(g => { %>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="genres" value="<%= g %>" required/>
                <label class="form-check-label"><%= g %></label>
              </div>
            <% }) %>
          </div>
          <div class="mb-3">
            <label class="form-label">Total Weight (kg, optional)</label>
            <input type="number" name="weight" step="0.01" class="form-control"/>
          </div>
          <button type="submit" class="btn btn-info">Record Donation</button>
        </form>
      </div>
    </div>

    <!-- Change History (Admin Only) -->
    <% if (user.role === 'admin') { %>
      <div class="card mb-5">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <span>Change History</span>
          <button class="btn btn-sm btn-light" onclick="loadHistory()">Refresh</button>
        </div>
        <div class="card-body">
          <div id="historyContainer">
            <p class="text-muted">Click "Refresh" to load change history...</p>
          </div>
        </div>
      </div>
    <% } %>

  </div>

  <!-- Delete Confirmation Modal -->
  <% if (user.role === 'admin') { %>
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete <strong><%= member.firstName %> <%= member.lastName %></strong>?</p>
            <p class="text-muted small">This is a soft delete - the record can be restored later by an admin.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form action="/members/<%= member._id %>/delete" method="POST" class="d-inline">
              <button type="submit" class="btn btn-danger">Delete Member</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <% if (user.role === 'admin') { %>
  <script>
    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      container.innerHTML = '<p class="text-muted">Loading...</p>';

      try {
        const response = await fetch('/members/<%= member._id %>/history');
        const history = await response.json();

        if (history.length === 0) {
          container.innerHTML = '<p class="text-muted">No changes recorded yet.</p>';
          return;
        }

        let html = '<table class="table table-sm"><thead><tr><th>Date</th><th>Action</th><th>Changed By</th><th>Details</th></tr></thead><tbody>';

        history.forEach(entry => {
          const date = new Date(entry.timestamp).toLocaleString();
          const user = entry.performedBy ? `${entry.performedBy.firstName || ''} ${entry.performedBy.lastName || ''}`.trim() || entry.performedBy.email : 'Unknown';
          const action = entry.action.charAt(0).toUpperCase() + entry.action.slice(1);

          let details = '';
          if (entry.action === 'update' && entry.changedFields && entry.changedFields.length > 0) {
            details = 'Changed: ' + entry.changedFields.join(', ');
          } else if (entry.summary) {
            details = entry.summary;
          }

          let badgeClass = 'bg-secondary';
          if (entry.action === 'create') badgeClass = 'bg-success';
          if (entry.action === 'update') badgeClass = 'bg-primary';
          if (entry.action === 'delete') badgeClass = 'bg-danger';
          if (entry.action === 'restore') badgeClass = 'bg-warning text-dark';

          html += `<tr>
            <td><small>${date}</small></td>
            <td><span class="badge ${badgeClass}">${action}</span></td>
            <td><small>${user}</small></td>
            <td><small>${details}</small></td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<p class="text-danger">Failed to load history.</p>';
        console.error('Error loading history:', err);
      }
    }

    // Auto-load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
  <% } %>
</body>
</html>
