<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= week ? 'Edit' : 'Add' %> Week - Sidewalk Books</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/treehouse-brand.css">
</head>
<body>
  <%- include('partials/nav') %>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1><i class="bi bi-shop"></i> <%= week ? 'Edit' : 'Add' %> Weekly Record</h1>
        <p class="text-muted">Sidewalk Books inventory tracking</p>
      </div>
      <a href="/sidewalk-books" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
      </a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <div class="card">
      <div class="card-header" style="background-color: var(--thb-primary); color: white;">
        <h5 class="mb-0">
          <i class="bi bi-calendar-week"></i> Weekly Inventory
        </h5>
      </div>
      <div class="card-body">
        <form method="POST" action="<%= week ? '/sidewalk-books/' + week._id : '/sidewalk-books' %>">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="weekStart" class="form-label">Week Start (Monday) *</label>
              <input
                type="date"
                class="form-control"
                id="weekStart"
                name="weekStart"
                value="<%= week ? new Date(week.weekStart).toISOString().split('T')[0] : defaultWeekStart %>"
                required
                onchange="updateWeekEnd()"
              >
            </div>
            <div class="col-md-6">
              <label for="weekEnd" class="form-label">Week End (Sunday) *</label>
              <input
                type="date"
                class="form-control"
                id="weekEnd"
                name="weekEnd"
                value="<%= week ? new Date(week.weekEnd).toISOString().split('T')[0] : defaultWeekEnd %>"
                required
              >
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="startCount" class="form-label">Start of Week Count *</label>
              <input
                type="number"
                class="form-control"
                id="startCount"
                name="startCount"
                min="0"
                max="100000"
                value="<%= week ? week.startCount : '' %>"
                required
                onchange="calculateChange()"
                oninput="calculateChange()"
              >
              <small class="text-muted">Number of books at the start of the week</small>
            </div>
            <div class="col-md-6">
              <label for="endCount" class="form-label">End of Week Count *</label>
              <input
                type="number"
                class="form-control"
                id="endCount"
                name="endCount"
                min="0"
                max="100000"
                value="<%= week ? week.endCount : '' %>"
                required
                onchange="calculateChange()"
                oninput="calculateChange()"
              >
              <small class="text-muted">Number of books at the end of the week</small>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Calculated Change</label>
            <div class="alert alert-info" id="changeDisplay">
              <i class="bi bi-calculator"></i>
              <span id="changeText">Enter start and end counts to see the change</span>
            </div>
          </div>

          <div class="mb-3">
            <label for="notes" class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="notes"
              name="notes"
              rows="3"
              placeholder="Any notes about this week..."
              maxlength="1000"
            ><%= week && week.notes ? week.notes : '' %></textarea>
          </div>

          <div class="text-end">
            <a href="/sidewalk-books" class="btn btn-secondary me-2">Cancel</a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle"></i> <%= week ? 'Update' : 'Save' %> Record
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function updateWeekEnd() {
      const weekStart = document.getElementById('weekStart').value;
      if (weekStart) {
        const startDate = new Date(weekStart);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        document.getElementById('weekEnd').value = endDate.toISOString().split('T')[0];
      }
    }

    function calculateChange() {
      const startCount = parseInt(document.getElementById('startCount').value) || 0;
      const endCount = parseInt(document.getElementById('endCount').value) || 0;
      const change = endCount - startCount;
      const changeText = document.getElementById('changeText');
      const changeDisplay = document.getElementById('changeDisplay');

      if (document.getElementById('startCount').value && document.getElementById('endCount').value) {
        let changeLabel = '';
        if (change > 0) {
          changeLabel = `+${change} books added`;
          changeDisplay.className = 'alert alert-success';
        } else if (change < 0) {
          changeLabel = `${change} books removed`;
          changeDisplay.className = 'alert alert-warning';
        } else {
          changeLabel = 'No change';
          changeDisplay.className = 'alert alert-info';
        }
        changeText.textContent = changeLabel;
      } else {
        changeText.textContent = 'Enter start and end counts to see the change';
        changeDisplay.className = 'alert alert-info';
      }
    }

    // Initialize on page load
    calculateChange();
  </script>
</body>
</html>
